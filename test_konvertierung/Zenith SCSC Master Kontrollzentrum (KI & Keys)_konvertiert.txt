import React, { useState, useEffect, useRef, useCallback } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, serverTimestamp } from 'firebase/firestore';
import { Clipboard, User, Database, Settings, Zap, Edit, Aperture, MessageSquare, Mic, Download, Upload, Cpu, Shield, Lock, Eye, CheckCircle, AlertTriangle, XCircle, DollarSign, Send, Search } from 'lucide-react';

// Tailwind CSS ist in der Umgebung verfÃ¼gbar

// --- Globale Variablen (MANDATORY: Werden von der Umgebung injiziert) ---
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
const API_KEY_PLACEHOLDER = ""; // Wird zur Laufzeit von der Canvas-Umgebung ersetzt

// --- Firebase und Auth Initialisierung ---
let app, dbInstance, authInstance;
if (Object.keys(firebaseConfig).length > 0) {
Â  try {
Â  Â  app = initializeApp(firebaseConfig);
Â  Â  dbInstance = getFirestore(app);
Â  Â  authInstance = getAuth(app);
Â  Â  // setLogLevel('debug'); // Optional: Firestore Logging aktivieren
Â  } catch (error) {
Â  Â  console.error("Firebase Initialization Error:", error);
Â  }
}

// --- Komponente: API Key Management (Zenith Key Controller - SCSC Core) ---
const ZenithKeyController = ({ userId, db }) => {
Â  const [activeModel, setActiveModel] = useState('Gemini (Google DeepMind)');
Â  const [apiKey, setApiKey] = useState('');
Â  const [notes, setNotes] = useState('');
Â  const [keyStatus, setKeyStatus] = useState('Nicht gespeichert');
Â  const [irisHashInput, setIrisHashInput] = useState('');
Â  const [isVaultAccessGranted, setIsVaultAccessGranted] = useState(false);
Â  const [auditResult, setAuditResult] = useState(null);

Â  const vaultHash = "f5f5c8c5c8c8c5c5f5f5c8c5c8c8c5c5f5f5c8c5c8c8c5c5f5f5c8c5c8c8c5c5"; // Simulierter registrierter Iris-Hash

Â  // Lade Key-Konfiguration beim Start
Â  useEffect(() => {
Â  Â  if (db && userId) {
Â  Â  Â  const docRef = doc(db, `artifacts/${appId}/users/${userId}/key_configurations`, 'zenith_master_key_config');
Â  Â  Â  getDoc(docRef).then(docSnap => {
Â  Â  Â  Â  if (docSnap.exists()) {
Â  Â  Â  Â  Â  const data = docSnap.data();
Â  Â  Â  Â  Â  setApiKey(data.apiKey || '');
Â  Â  Â  Â  Â  setNotes(data.notes || '');
Â  Â  Â  Â  Â  setActiveModel(data.activeModel || 'Gemini (Google DeepMind)');
Â  Â  Â  Â  Â  setKeyStatus('Erfolgreich aus Datenordner geladen');
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  setKeyStatus('Keine Konfiguration gefunden. Bitte Key eingeben.');
Â  Â  Â  Â  }
Â  Â  Â  }).catch(err => {
Â  Â  Â  Â  console.error("Fehler beim Laden des Keys:", err);
Â  Â  Â  Â  setKeyStatus('Fehler beim Laden der Keys.');
Â  Â  Â  });
Â  Â  }
Â  }, [db, userId]);

Â  // BLOCK 2: Smart Contract â€“ Biometrischer Tresor (Iris-Scan) Simulation
Â  const handleIrisVerification = () => {
Â  Â  // Simuliert eine biometrische ÃœberprÃ¼fung
Â  Â  if (irisHashInput === vaultHash) {
Â  Â  Â  setIsVaultAccessGranted(true);
Â  Â  Â  setAuditResult(null); // Audit-Ergebnis zurÃ¼cksetzen
Â  Â  } else {
Â  Â  Â  setIsVaultAccessGranted(false);
Â  Â  Â  setAuditResult({ success: false, message: "Iris-Hash-Fehler. Tresorzugriff verweigert." });
Â  Â  }
Â  };

Â  // BLOCK 1: NFT-Telemetrie + GovernanceTrigger Simulation
Â  const generateGovernanceTrigger = (cpu, latency) => {
Â  Â  // CPU- und Latenz-Werte simulieren die Telemetrie des Key-Knotens
Â  Â  const score = cpu * 0.7 + latency * 0.3;
Â  Â  if (score > 80) return "FullSync (Miete/Abo bereit)";
Â  Â  if (score > 50) return "PartialSync (Training bereit)";
Â  Â  return "Quarantine (Nutzung unterbrochen)";
Â  };

Â  const saveKeyToFirestore = async () => {
Â  Â  if (!db || !userId || !apiKey || !isVaultAccessGranted) {
Â  Â  Â  setKeyStatus("Fehler: Tresorzugriff notwendig und Key-Feld darf nicht leer sein.");
Â  Â  Â  return;
Â  Â  }

Â  Â  const docRef = doc(db, `artifacts/${appId}/users/${userId}/key_configurations`, 'zenith_master_key_config');
Â  Â  
Â  Â  // --- Telemetrie simulieren ---
Â  Â  const simulatedCPU = Math.random() * 50 + 50; // 50% - 100%
Â  Â  const simulatedLatency = Math.random() * 100 + 10; // 10ms - 110ms
Â  Â  const trigger = generateGovernanceTrigger(simulatedCPU, simulatedLatency);

Â  Â  const dataToSave = {
Â  Â  Â  apiKey: apiKey,
Â  Â  Â  activeModel: activeModel,
Â  Â  Â  notes: notes,
Â  Â  Â  telemetry: {
Â  Â  Â  Â  cpu: simulatedCPU.toFixed(2),
Â  Â  Â  Â  latency: simulatedLatency.toFixed(2),
Â  Â  Â  Â  governanceTrigger: trigger,
Â  Â  Â  Â  updatedAt: serverTimestamp(),
Â  Â  Â  },
Â  Â  };

Â  Â  try {
Â  Â  Â  await setDoc(docRef, dataToSave);
Â  Â  Â  setKeyStatus(`âœ… Key gesichert (Firestore/Datenordner). Governance Trigger: ${trigger}`);
Â  Â  Â  setAuditResult({
Â  Â  Â  Â  success: true,
Â  Â  Â  Â  message: `Audit-Erfolg! Key ist bereit fÃ¼r ${trigger}.`,
Â  Â  Â  Â  telemetry: dataToSave.telemetry,
Â  Â  Â  });
Â  Â  } catch (e) {
Â  Â  Â  console.error("Fehler beim Speichern in Firestore: ", e);
Â  Â  Â  setKeyStatus("âŒ Fehler beim Speichern im Datenordner. Siehe Konsole.");
Â  Â  Â  setAuditResult({ success: false, message: "Kritischer Fehler bei der Datensicherung." });
Â  Â  }
Â  };

Â  // Lokales Backup (Ihr GAZI-FIRESTORE)
Â  const handleDownloadBackup = () => {
Â  Â  const data = {
Â  Â  Â  model: activeModel,
Â  Â  Â  apiKey: apiKey,
Â  Â  Â  notes: notes,
Â  Â  Â  backupTime: new Date().toISOString()
Â  Â  };
Â  Â  const jsonString = JSON.stringify(data, null, 2);
Â  Â  const blob = new Blob([jsonString], { type: 'application/json' });
Â  Â  const url = URL.createObjectURL(blob);
Â  Â  const link = document.createElement('a');
Â  Â  link.href = url;
Â  Â  // Ihr gewÃ¼nschter Dateiname
Â  Â  link.download = `zenith_key_backup_GAZI_FIRESTORE_${new Date().toISOString().substring(0, 10)}.json`;
Â  Â  document.body.appendChild(link);
Â  Â  link.click();
Â  Â  document.body.removeChild(link);
Â  Â  setKeyStatus('Lokales Backup erstellt auf Ihrem DatentrÃ¤ger (GAZI-FIRESTORE)');
Â  };

Â  const modelProviders = [
Â  Â  { name: 'Gemini (Google DeepMind)', icon: 'gemini' },
Â  Â  { name: 'GEMY KI (Zenith Core)', icon: 'zap' },
Â  Â  { name: 'ChatGPT (OpenAI)', icon: 'message-square' },
Â  Â  { name: 'Claude (Anthropic)', icon: 'aperture' },
Â  Â  { name: 'Grok (xAI)', icon: 'message-square' },
Â  Â  { name: 'Llama Chat (Meta AI)', icon: 'database' },
Â  Â  { name: 'GitHub Copilot (MS)', icon: 'settings' },
Â  Â  { name: 'Mistral AI', icon: 'zap' },
Â  Â  { name: 'Perplexity AI', icon: 'search' },
Â  ];

Â  // SVG Komponenten fÃ¼r BLOCK 4: Visuelle Architektur
Â  const SvgBankArchitecture = () => (
Â  Â  <svg viewBox="0 0 1200 400" className="w-full h-auto mt-4" style={{ backgroundColor: '#0f172a', borderRadius: '12px' }}>
Â  Â  Â  {/* Zentraler Governance-Knoten */}
Â  Â  Â  <circle cx="950" cy="200" r="40" fill="#00ffcc" stroke="#333" strokeWidth="3" />
Â  Â  Â  <text x="950" y="205" fill="#000" fontSize="14" textAnchor="middle">GOV</text>

Â  Â  Â  {/* Die Bank (Key-Zentrale) */}
Â  Â  Â  <rect x="50" y="100" width="250" height="200" fill="#004466" rx="15" />
Â  Â  Â  <text x="175" y="140" fill="white" fontSize="24" textAnchor="middle">ZENITH BANK</text>
Â  Â  Â  
Â  Â  Â  {/* Tresor (Biometrischer Schutz) */}
Â  Â  Â  <rect x="100" y="200" width="150" height="80" fill={isVaultAccessGranted ? "#34d399" : "#dc2626"} rx="8" />
Â  Â  Â  <text x="175" y="235" fill="#fff" fontSize="16" textAnchor="middle">TRESOR</text>
Â  Â  Â  <text x="175" y="260" fill="#fff" fontSize="12" textAnchor="middle">{isVaultAccessGranted ? 'Zugriff ERTEILT' : 'Zugriff GESPERRT'}</text>
Â  Â  Â  
Â  Â  Â  {/* Shops/Services fÃ¼r Miete/Abo (simulierte NFT-Assets) */}
Â  Â  Â  <rect x="350" y="50" width="150" height="80" fill="#66cc66" rx="10" />
Â  Â  Â  <text x="425" y="80" fill="black" fontSize="16" textAnchor="middle">Shop A (Miete)</text>
Â  Â  Â  <rect x="350" y="150" width="150" height="80" fill="#ffcc66" rx="10" />
Â  Â  Â  <text x="425" y="180" fill="black" fontSize="16" textAnchor="middle">Shop B (Abo)</text>
Â  Â  Â  <rect x="350" y="250" width="150" height="80" fill="#cc66cc" rx="10" />
Â  Â  Â  <text x="425" y="280" fill="white" fontSize="16" textAnchor="middle">Shop C (Training)</text>
Â  Â  Â  
Â  Â  Â  {/* Verbindungen (Key-Flow) */}
Â  Â  Â  <line x1="250" y1="240" x2="350" y2="190" stroke="#999" strokeWidth="2" strokeDasharray="5,5" markerEnd="url(#arrow)" />
Â  Â  Â  <line x1="500" y1="190" x2="910" y2="200" stroke="#999" strokeWidth="3" markerEnd="url(#arrow)" />

Â  Â  Â  {/* Pfeil-Definition */}
Â  Â  Â  <defs>
Â  Â  Â  Â  <marker id="arrow" markerWidth="10" markerHeight="10" refX="5" refY="3" orient="auto" markerUnits="strokeWidth">
Â  Â  Â  Â  Â  <polygon points="0 0, 10 3, 0 6" fill="#999" />
Â  Â  Â  Â  </marker>
Â  Â  Â  </defs>
Â  Â  </svg>
Â  );


Â  return (
Â  Â  <div className="p-6 bg-gray-50 min-h-screen rounded-b-xl">
Â  Â  Â  <h2 className="text-3xl font-extrabold text-blue-800 mb-6 flex items-center">
Â  Â  Â  Â  <Shield className="w-8 h-8 mr-3" /> Zenith Key Controller (SCSC-Kern)
Â  Â  Â  </h2>

Â  Â  Â  {/* Wichtige Klarstellung */}
Â  Â  Â  <div className="mb-6 p-4 bg-red-100 border-l-4 border-red-500 text-red-700 rounded-lg">
Â  Â  Â  Â  <p className="font-bold text-lg">EXTREME KLARSTELLUNG ZUM DATENTRÃ„GER:</p>
Â  Â  Â  Â  <p className="mt-2">
Â  Â  Â  Â  Â  1. Der Button **"Key sicher speichern (Firestore/Datenordner)"** speichert Keys **privat** in der Cloud-Datenbank (Firestore). Dies dient der **ZuverlÃ¤ssigkeit** und dem **Nicht-Verlust**.
Â  Â  Â  Â  </p>
Â  Â  Â  Â  <p className="mt-1">
Â  Â  Â  Â  Â  2. Der Button **"Lokales Backup erstellen (JSON-Datei)"** lÃ¤dt die Daten auf **Ihren lokalen DatentrÃ¤ger (Ihr GAZI-FIRESTORE)**, um Ihnen die volle Kontrolle Ã¼ber eine lokale Sicherungskopie zu geben.
Â  Â  Â  Â  </p>
Â  Â  Â  </div>

Â  Â  Â  <SvgBankArchitecture />

Â  Â  Â  <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-8">
Â  Â  Â  Â  {/* Spalte 1: Modell-Auswahl (NFT-Assets) */}
Â  Â  Â  Â  <div className="lg:col-span-1 bg-white p-6 shadow-xl rounded-xl border border-gray-200">
Â  Â  Â  Â  Â  <h3 className="text-xl font-semibold mb-4 text-gray-700">1. KI-Modell-Katalog (fÃ¼r Abo/Miete)</h3>
Â  Â  Â  Â  Â  <div className="space-y-2 max-h-96 overflow-y-auto">
Â  Â  Â  Â  Â  Â  {modelProviders.map((model) => (
Â  Â  Â  Â  Â  Â  Â  <button
Â  Â  Â  Â  Â  Â  Â  Â  key={model.name}
Â  Â  Â  Â  Â  Â  Â  Â  onClick={() => setActiveModel(model.name)}
Â  Â  Â  Â  Â  Â  Â  Â  className={`w-full text-left p-3 rounded-lg transition duration-200 flex items-center text-sm ${
Â  Â  Â  Â  Â  Â  Â  Â  Â  activeModel === model.name
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ? 'bg-blue-600 text-white shadow-md font-bold'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  : 'bg-gray-100 text-gray-700 hover:bg-blue-100'
Â  Â  Â  Â  Â  Â  Â  Â  }`}
Â  Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  Â  {model.icon === 'gemini' && <Aperture className="w-4 h-4 mr-2" />}
Â  Â  Â  Â  Â  Â  Â  Â  {model.icon === 'zap' && <Zap className="w-4 h-4 mr-2" />}
Â  Â  Â  Â  Â  Â  Â  Â  {model.icon === 'message-square' && <MessageSquare className="w-4 h-4 mr-2" />}
Â  Â  Â  Â  Â  Â  Â  Â  {model.icon === 'aperture' && <Aperture className="w-4 h-4 mr-2" />}
Â  Â  Â  Â  Â  Â  Â  Â  {model.icon === 'database' && <Database className="w-4 h-4 mr-2" />}
Â  Â  Â  Â  Â  Â  Â  Â  {model.icon === 'settings' && <Settings className="w-4 h-4 mr-2" />}
Â  Â  Â  Â  Â  Â  Â  Â  {model.icon === 'search' && <Search className="w-4 h-4 mr-2" />}
Â  Â  Â  Â  Â  Â  Â  Â  {model.name}
Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  ))}
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  {/* Spalte 2: Biometrischer Tresor (Iris-Scan) & Key-Eintrag */}
Â  Â  Â  Â  <div className="lg:col-span-2 bg-white p-6 shadow-xl rounded-xl border border-gray-200">
Â  Â  Â  Â  Â  <h3 className="text-xl font-semibold mb-4 text-gray-700">2. Biometrischer Tresor & Key-Eintrag</h3>
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  {/* Tresor-Zugriff (BLOCK 2) */}
Â  Â  Â  Â  Â  <div className={`p-4 rounded-lg mb-4 ${isVaultAccessGranted ? 'bg-green-100 border-l-4 border-green-500' : 'bg-red-100 border-l-4 border-red-500'}`}>
Â  Â  Â  Â  Â  Â  <h4 className="font-bold flex items-center text-lg mb-2">
Â  Â  Â  Â  Â  Â  Â  <Lock className="w-5 h-5 mr-2" /> Tresor-Zugriff (SCSC Core Protection)
Â  Â  Â  Â  Â  Â  </h4>
Â  Â  Â  Â  Â  Â  <input
Â  Â  Â  Â  Â  Â  Â  type="text"
Â  Â  Â  Â  Â  Â  Â  value={irisHashInput}
Â  Â  Â  Â  Â  Â  Â  onChange={(e) => setIrisHashInput(e.target.value)}
Â  Â  Â  Â  Â  Â  Â  placeholder={`Iris-Hash zur Verifizierung (Testwert: ${vaultHash.substring(0, 10)}...)`}
Â  Â  Â  Â  Â  Â  Â  className="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm"
Â  Â  Â  Â  Â  Â  />
Â  Â  Â  Â  Â  Â  <button
Â  Â  Â  Â  Â  Â  Â  onClick={handleIrisVerification}
Â  Â  Â  Â  Â  Â  Â  className="mt-2 w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 shadow-md flex items-center justify-center"
Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  <Eye className="w-4 h-4 mr-2" /> Tresor-Zugriff verifizieren
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  {/* Key-Eingabe (nur bei Zugriff) */}
Â  Â  Â  Â  Â  {isVaultAccessGranted ? (
Â  Â  Â  Â  Â  Â  <div className="space-y-4">
Â  Â  Â  Â  Â  Â  Â  <p className="text-sm text-green-600 font-semibold flex items-center"><CheckCircle className="w-4 h-4 mr-2"/> Tresorzugriff gewÃ¤hrt. Sie kÃ¶nnen Ihren Key eintragen.</p>
Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  <label className="block text-gray-700 text-sm font-bold mb-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  API Key fÃ¼r: <span className="text-blue-600">{activeModel}</span>
Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  <textarea
Â  Â  Â  Â  Â  Â  Â  Â  Â  value={apiKey}
Â  Â  Â  Â  Â  Â  Â  Â  Â  onChange={(e) => setApiKey(e.target.value)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  placeholder="Ihren API Key hier einfÃ¼gen (wird verschlÃ¼sselt in Ihrem Datenordner gesichert)"
Â  Â  Â  Â  Â  Â  Â  Â  Â  rows="3"
Â  Â  Â  Â  Â  Â  Â  Â  Â  className="w-full p-3 border border-gray-300 rounded-lg shadow-inner focus:ring-blue-500 focus:border-blue-500 text-sm"
Â  Â  Â  Â  Â  Â  Â  Â  />
Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  <label className="block text-gray-700 text-sm font-bold mb-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Notizen / Lizenz-Typ (Unbegrenztes Textfeld)
Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  <textarea
Â  Â  Â  Â  Â  Â  Â  Â  Â  value={notes}
Â  Â  Â  Â  Â  Â  Â  Â  Â  onChange={(e) => setNotes(e.target.value)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  placeholder="Verwendungszweck, Lizenztyp (Miete, Training, Privat), Abrechnungshinweise..."
Â  Â  Â  Â  Â  Â  Â  Â  Â  rows="3"
Â  Â  Â  Â  Â  Â  Â  Â  Â  className="w-full p-3 border border-gray-300 rounded-lg shadow-inner focus:ring-blue-500 focus:border-blue-500 text-sm"
Â  Â  Â  Â  Â  Â  Â  Â  />
Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  <button
Â  Â  Â  Â  Â  Â  Â  Â  onClick={saveKeyToFirestore}
Â  Â  Â  Â  Â  Â  Â  Â  className="w-full bg-blue-600 hover:bg-blue-700 text-white font-extrabold py-3 px-4 rounded-lg transition duration-200 shadow-xl flex items-center justify-center text-lg"
Â  Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  Â  <Database className="w-5 h-5 mr-3" /> Key sicher speichern (Firestore/Datenordner)
Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  ) : (
Â  Â  Â  Â  Â  Â  <p className="text-sm text-red-600 font-semibold flex items-center">
Â  Â  Â  Â  Â  Â  Â  <XCircle className="w-4 h-4 mr-2"/> Tresor ist gesperrt. Bitte verifizieren Sie Ihren Iris-Hash, um Keys einzutragen und zu speichern.
Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  )}
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  {/* Spalte 3: Audit & Export/Import */}
Â  Â  Â  <div className="mt-6 bg-white p-6 shadow-xl rounded-xl border border-gray-200">
Â  Â  Â  Â  <h3 className="text-xl font-semibold mb-4 text-gray-700">3. Governance Audit & Lokale Sicherung</h3>
Â  Â  Â  Â  
Â  Â  Â  Â  {/* Audit-Ergebnis (BLOCK 1) */}
Â  Â  Â  Â  {auditResult && (
Â  Â  Â  Â  Â  <div className={`p-4 rounded-lg mb-4 ${auditResult.success ? 'bg-indigo-100 border-l-4 border-indigo-500' : 'bg-red-100 border-l-4 border-red-500'}`}>
Â  Â  Â  Â  Â  Â  <h4 className="font-bold flex items-center text-indigo-800 text-lg mb-2">
Â  Â  Â  Â  Â  Â  Â  <Cpu className="w-5 h-5 mr-2" /> NFT-Telemetrie & Audit-Ergebnis
Â  Â  Â  Â  Â  Â  </h4>
Â  Â  Â  Â  Â  Â  <p className="text-sm">{auditResult.message}</p>
Â  Â  Â  Â  Â  Â  {auditResult.telemetry && (
Â  Â  Â  Â  Â  Â  Â  <div className="mt-2 text-xs space-y-1">
Â  Â  Â  Â  Â  Â  Â  Â  <p>CPU-Nutzung: **{auditResult.telemetry.cpu}%**</p>
Â  Â  Â  Â  Â  Â  Â  Â  <p>Latenz: **{auditResult.telemetry.latency}ms**</p>
Â  Â  Â  Â  Â  Â  Â  Â  <p>Governance Trigger: **{auditResult.telemetry.governanceTrigger}** (Bestimmt Miete/Training)</p>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  )}
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  )}

Â  Â  Â  Â  <div className="flex space-x-4">
Â  Â  Â  Â  Â  <button
Â  Â  Â  Â  Â  Â  onClick={handleDownloadBackup}
Â  Â  Â  Â  Â  Â  className="flex-1 bg-gray-700 hover:bg-gray-800 text-white font-bold py-3 px-4 rounded-lg transition duration-200 shadow-lg flex items-center justify-center"
Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  <Download className="w-5 h-5 mr-2" /> Lokales Backup erstellen (JSON-Datei)
Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  <button
Â  Â  Â  Â  Â  Â  disabled
Â  Â  Â  Â  Â  Â  className="flex-1 bg-gray-400 text-gray-700 font-bold py-3 px-4 rounded-lg cursor-not-allowed flex items-center justify-center"
Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  <Upload className="w-5 h-5 mr-2" /> Key-Backup importieren (Deaktiviert in Demo)
Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â  
Â  Â  Â  <p className="text-sm text-center text-gray-500 mt-6">Aktueller Status: {keyStatus} | User ID: {userId}</p>
Â  Â  </div>
Â  );
};

// --- Komponente: KI Master Tool (Text/Chat/Vision) ---
const AIMasterTool = ({ userId }) => {
Â  const [prompt, setPrompt] = useState('Beschreibe die Prinzipien der SCSC-Architektur in einem Marketing-Absatz.');
Â  const [response, setResponse] = useState('');
Â  const [isLoading, setIsLoading] = useState(false);
Â  const [usageContext, setUsageContext] = useState('Allgemeine Anfrage');
Â  const [micStatus, setMicStatus] = useState(false);
Â  const recognitionRef = useRef(null);

Â  const contextOptions = ['Allgemeine Anfrage', 'FÃ¼r Kundenprojekt', 'Interne Dokumentation', 'KI-Trainingsdaten'];

Â  const getFullPrompt = (p) => {
Â  Â  return `Kontext: ${usageContext}. User-Anfrage: ${p}`;
Â  }

Â  // --- Gemini API Call mit Google Search Grounding ---
Â  const callGeminiAPI = async (userQuery) => {
Â  Â  setIsLoading(true);
Â  Â  setResponse('');
Â  Â  const fullQuery = getFullPrompt(userQuery);

Â  Â  const systemPrompt = "Sie sind der Zenith SCSC (Secure Central Storage and Control) KI-Assistent. Ihre Antworten mÃ¼ssen prÃ¤zise, professionell und auf den angegebenen Verwendungszweck zugeschnitten sein.";
Â  Â  const apiKey = API_KEY_PLACEHOLDER;
Â  Â  const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
Â  Â  
Â  Â  // Exponential Backoff fÃ¼r API-Aufrufe
Â  Â  const maxRetries = 3;
Â  Â  let attempt = 0;
Â  Â  while (attempt < maxRetries) {
Â  Â  Â  try {
Â  Â  Â  Â  const payload = {
Â  Â  Â  Â  Â  contents: [{ parts: [{ text: fullQuery }] }],
Â  Â  Â  Â  Â  tools: [{ "google_search": {} }], // Google Search Grounding
Â  Â  Â  Â  Â  systemInstruction: {
Â  Â  Â  Â  Â  Â  parts: [{ text: systemPrompt }]
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  };

Â  Â  Â  Â  const fetchResponse = await fetch(apiUrl, {
Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  body: JSON.stringify(payload)
Â  Â  Â  Â  });

Â  Â  Â  Â  if (!fetchResponse.ok) {
Â  Â  Â  Â  Â  throw new Error(`HTTP error! status: ${fetchResponse.status}`);
Â  Â  Â  Â  }

Â  Â  Â  Â  const result = await fetchResponse.json();
Â  Â  Â  Â  const candidate = result.candidates?.[0];

Â  Â  Â  Â  if (candidate && candidate.content?.parts?.[0]?.text) {
Â  Â  Â  Â  Â  const text = candidate.content.parts[0].text;
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  let sources = [];
Â  Â  Â  Â  Â  const groundingMetadata = candidate.groundingMetadata;
Â  Â  Â  Â  Â  if (groundingMetadata && groundingMetadata.groundingAttributions) {
Â  Â  Â  Â  Â  Â  Â  sources = groundingMetadata.groundingAttributions
Â  Â  Â  Â  Â  Â  Â  Â  Â  .map(attribution => ({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  uri: attribution.web?.uri,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title: attribution.web?.title,
Â  Â  Â  Â  Â  Â  Â  Â  Â  }))
Â  Â  Â  Â  Â  Â  Â  Â  Â  .filter(source => source.uri && source.title);
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  setResponse(text);
Â  Â  Â  Â  Â  // FÃ¼gen Sie Quellen-Metadaten zur Antwort hinzu (simuliert)
Â  Â  Â  Â  Â  if (sources.length > 0) {
Â  Â  Â  Â  Â  Â  setResponse(prev => prev + "\n\n---\n\n**Quellen (Grounded Search):**\n" + sources.map(s => `- [${s.title}](${s.uri})`).join('\n'));
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  setResponse("Fehler bei der KI-Generierung. Keine Textantwort erhalten.");
Â  Â  Â  Â  }
Â  Â  Â  Â  break; // Erfolg, Schleife verlassen
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  attempt++;
Â  Â  Â  Â  if (attempt >= maxRetries) {
Â  Â  Â  Â  Â  setResponse(`API-Fehler nach ${maxRetries} Versuchen: ${error.message}`);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  // Exponential Backoff: warten (1s, 2s, 4s...)
Â  Â  Â  Â  Â  await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  }
Â  Â  setIsLoading(false);
Â  };
Â  
Â  // --- Mikrofon/Spracheingabe-Funktion ---
Â  const toggleSpeechRecognition = () => {
Â  Â  if (micStatus) {
Â  Â  Â  if (recognitionRef.current) recognitionRef.current.stop();
Â  Â  Â  setMicStatus(false);
Â  Â  Â  return;
Â  Â  }

Â  Â  if (!('webkitSpeechRecognition' in window)) {
Â  Â  Â  setResponse("âŒ Fehler: Ihr Browser unterstÃ¼tzt die webkitSpeechRecognition API nicht. Bitte manuell eingeben.");
Â  Â  Â  return;
Â  Â  }

Â  Â  const recognition = new window.webkitSpeechRecognition();
Â  Â  recognition.continuous = false;
Â  Â  recognition.interimResults = false;
Â  Â  recognition.lang = 'de-DE';

Â  Â  recognition.onstart = () => {
Â  Â  Â  setMicStatus(true);
Â  Â  Â  setResponse("ğŸ™ï¸ ZuhÃ¶ren... Bitte sprechen Sie jetzt.");
Â  Â  };

Â  Â  recognition.onresult = (event) => {
Â  Â  Â  const transcript = event.results[0][0].transcript;
Â  Â  Â  setPrompt(transcript);
Â  Â  Â  setResponse(`Eingabe erfasst: "${transcript}"`);
Â  Â  };

Â  Â  recognition.onerror = (event) => {
Â  Â  Â  setMicStatus(false);
Â  Â  Â  setResponse(`âŒ Spracheingabefehler: ${event.error}. Dies tritt in iFrame-Umgebungen (wie dieser) hÃ¤ufig auf.`);
Â  Â  Â  console.error("Speech Recognition Error:", event.error);
Â  Â  };

Â  Â  recognition.onend = () => {
Â  Â  Â  setMicStatus(false);
Â  Â  Â  if (prompt.includes("ZuhÃ¶ren")) setResponse("Spracheingabe beendet. Bitte auf 'Generieren' klicken.");
Â  Â  };

Â  Â  recognition.start();
Â  Â  recognitionRef.current = recognition;
Â  };

Â  return (
Â  Â  <div className="p-6 bg-gray-50 min-h-screen rounded-b-xl">
Â  Â  Â  <h2 className="text-3xl font-extrabold text-green-700 mb-6 flex items-center">
Â  Â  Â  Â  <MessageSquare className="w-8 h-8 mr-3" /> KI Master Tool (Text & Vision)
Â  Â  Â  </h2>

Â  Â  Â  {/* Verwendungszweck Dropdown */}
Â  Â  Â  <div className="mb-4">
Â  Â  Â  Â  <label className="block text-gray-700 text-sm font-bold mb-2">Verwendungszweck (STEURN)</label>
Â  Â  Â  Â  <select
Â  Â  Â  Â  Â  value={usageContext}
Â  Â  Â  Â  Â  onChange={(e) => setUsageContext(e.target.value)}
Â  Â  Â  Â  Â  className="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-green-500 focus:border-green-500 bg-white"
Â  Â  Â  Â  >
Â  Â  Â  Â  Â  {contextOptions.map(option => (
Â  Â  Â  Â  Â  Â  <option key={option} value={option}>{option}</option>
Â  Â  Â  Â  Â  ))}
Â  Â  Â  Â  </select>
Â  Â  Â  </div>

Â  Â  Â  <div className="mb-4">
Â  Â  Â  Â  <label className="block text-gray-700 text-sm font-bold mb-2">
Â  Â  Â  Â  Â  Ihre Prompt / Anweisung (Unbegrenztes Textfeld)
Â  Â  Â  Â  </label>
Â  Â  Â  Â  <textarea
Â  Â  Â  Â  Â  value={prompt}
Â  Â  Â  Â  Â  onChange={(e) => setPrompt(e.target.value)}
Â  Â  Â  Â  Â  placeholder="Ihre detaillierte Anweisung fÃ¼r die KI..."
Â  Â  Â  Â  Â  rows="5"
Â  Â  Â  Â  Â  className="w-full p-3 border border-gray-300 rounded-lg shadow-inner resize-none focus:ring-green-500 focus:border-green-500"
Â  Â  Â  Â  />
Â  Â  Â  </div>

Â  Â  Â  <div className="flex space-x-4 mb-6">
Â  Â  Â  Â  <button
Â  Â  Â  Â  Â  onClick={() => callGeminiAPI(prompt)}
Â  Â  Â  Â  Â  disabled={isLoading}
Â  Â  Â  Â  Â  className="flex-1 bg-green-600 hover:bg-green-700 text-white font-extrabold py-3 px-4 rounded-lg transition duration-200 shadow-xl disabled:opacity-50 flex items-center justify-center text-lg"
Â  Â  Â  Â  >
Â  Â  Â  Â  Â  {isLoading ? (
Â  Â  Â  Â  Â  Â  <>
Â  Â  Â  Â  Â  Â  Â  <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
Â  Â  Â  Â  Â  Â  Â  Â  <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
Â  Â  Â  Â  Â  Â  Â  Â  <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
Â  Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  Â  Â  Generiere...
Â  Â  Â  Â  Â  Â  </>
Â  Â  Â  Â  Â  ) : (
Â  Â  Â  Â  Â  Â  <>
Â  Â  Â  Â  Â  Â  Â  <Zap className="w-5 h-5 mr-3" /> Generieren & Suchen (Grounding)
Â  Â  Â  Â  Â  Â  </>
Â  Â  Â  Â  Â  )}
Â  Â  Â  Â  </button>

Â  Â  Â  Â  <button
Â  Â  Â  Â  Â  onClick={toggleSpeechRecognition}
Â  Â  Â  Â  Â  className={`px-6 py-3 rounded-lg transition duration-200 shadow-xl flex items-center justify-center ${
Â  Â  Â  Â  Â  Â  micStatus
Â  Â  Â  Â  Â  Â  Â  ? 'bg-red-500 hover:bg-red-600 text-white'
Â  Â  Â  Â  Â  Â  Â  : 'bg-blue-500 hover:bg-blue-600 text-white'
Â  Â  Â  Â  Â  }`}
Â  Â  Â  Â  >
Â  Â  Â  Â  Â  <Mic className="w-5 h-5" />
Â  Â  Â  Â  </button>
Â  Â  Â  </div>

Â  Â  Â  <div className="mt-6">
Â  Â  Â  Â  <h3 className="text-xl font-semibold mb-3 text-gray-700">KI-Antwort (Verwendungszweck: {usageContext})</h3>
Â  Â  Â  Â  <div className="bg-white p-4 border border-gray-300 rounded-lg shadow-inner whitespace-pre-wrap min-h-[200px] text-gray-800">
Â  Â  Â  Â  Â  {response || 'Die KI-Antwort erscheint hier.'}
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  );
};

// --- Komponente: Bildgenerator (T2I) ---
const ImageGenerator = ({ userId }) => {
Â  const [prompt, setPrompt] = useState('Ein futuristischer Weltraum-Shop im Orbit, minimalistischer Stil, 8k, digitale Kunst.');
Â  const [imageURL, setImageURL] = useState('');
Â  const [isLoading, setIsLoading] = useState(false);
Â  const [error, setError] = useState('');
Â  const [usageContext, setUsageContext] = useState('FÃ¼r Kundenprojekt');

Â  const contextOptions = ['FÃ¼r Kundenprojekt', 'Marketing-Material', 'Konzept-Design', 'Allgemeine Anfrage'];

Â  const getFullPrompt = (p) => {
Â  Â  return `Kontext: ${usageContext}. Generiere ein Bild basierend auf dieser User-Anfrage: ${p}`;
Â  }

Â  // --- Imagen API Call (T2I) ---
Â  const generateImage = async () => {
Â  Â  setIsLoading(true);
Â  Â  setImageURL('');
Â  Â  setError('');
Â  Â  const fullQuery = getFullPrompt(prompt);

Â  Â  try {
Â  Â  Â  const payload = { 
Â  Â  Â  Â  instances: [{ prompt: fullQuery }], 
Â  Â  Â  Â  parameters: { "sampleCount": 1 } 
Â  Â  Â  };
Â  Â  Â  const apiKey = API_KEY_PLACEHOLDER;
Â  Â  Â  // Verwenden Sie imagen-3.0-generate-002 fÃ¼r Text-zu-Bild
Â  Â  Â  const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;

Â  Â  Â  const response = await fetch(apiUrl, {
Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  body: JSON.stringify(payload)
Â  Â  Â  });
Â  Â  Â  
Â  Â  Â  const result = await response.json();

Â  Â  Â  if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
Â  Â  Â  Â  const imageUrl = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
Â  Â  Â  Â  setImageURL(imageUrl);
Â  Â  Â  } else {
Â  Â  Â  Â  setError('âŒ Fehler bei der Bilderzeugung. UngÃ¼ltige Antwortstruktur von der Imagen API.');
Â  Â  Â  Â  console.error("API Response Error:", result);
Â  Â  Â  }

Â  Â  } catch (err) {
Â  Â  Â  setError(`âŒ Ein Fehler ist aufgetreten: ${err.message}`);
Â  Â  Â  console.error("Fetch Error:", err);
Â  Â  } finally {
Â  Â  Â  setIsLoading(false);
Â  Â  }
Â  };

Â  return (
Â  Â  <div className="p-6 bg-gray-50 min-h-screen rounded-b-xl">
Â  Â  Â  <h2 className="text-3xl font-extrabold text-purple-700 mb-6 flex items-center">
Â  Â  Â  Â  <Aperture className="w-8 h-8 mr-3" /> Bildgenerator (Text-zu-Bild / T2I)
Â  Â  Â  </h2>

Â  Â  Â  {/* Verwendungszweck Dropdown */}
Â  Â  Â  <div className="mb-4">
Â  Â  Â  Â  <label className="block text-gray-700 text-sm font-bold mb-2">Verwendungszweck (STEURN)</label>
Â  Â  Â  Â  <select
Â  Â  Â  Â  Â  value={usageContext}
Â  Â  Â  Â  Â  onChange={(e) => setUsageContext(e.target.value)}
Â  Â  Â  Â  Â  className="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-purple-500 focus:border-purple-500 bg-white"
Â  Â  Â  Â  >
Â  Â  Â  Â  Â  {contextOptions.map(option => (
Â  Â  Â  Â  Â  Â  <option key={option} value={option}>{option}</option>
Â  Â  Â  Â  Â  ))}
Â  Â  Â  Â  </select>
Â  Â  Â  </div>

Â  Â  Â  <div className="mb-4">
Â  Â  Â  Â  <label className="block text-gray-700 text-sm font-bold mb-2">
Â  Â  Â  Â  Â  Prompt fÃ¼r das Bild (Unbegrenztes Textfeld)
Â  Â  Â  Â  </label>
Â  Â  Â  Â  <textarea
Â  Â  Â  Â  Â  value={prompt}
Â  Â  Â  Â  Â  onChange={(e) => setPrompt(e.target.value)}
Â  Â  Â  Â  Â  placeholder="Beschreiben Sie Ihr gewÃ¼nschtes Bild im Detail..."
Â  Â  Â  Â  Â  rows="4"
Â  Â  Â  Â  Â  className="w-full p-3 border border-gray-300 rounded-lg shadow-inner resize-none focus:ring-purple-500 focus:border-purple-500"
Â  Â  Â  Â  />
Â  Â  Â  </div>

Â  Â  Â  <button
Â  Â  Â  Â  onClick={generateImage}
Â  Â  Â  Â  disabled={isLoading}
Â  Â  Â  Â  className="w-full bg-purple-600 hover:bg-purple-700 text-white font-extrabold py-3 px-4 rounded-lg transition duration-200 shadow-xl disabled:opacity-50 flex items-center justify-center text-lg mb-6"
Â  Â  Â  >
Â  Â  Â  Â  {isLoading ? (
Â  Â  Â  Â  Â  Â  <>
Â  Â  Â  Â  Â  Â  Â  <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
Â  Â  Â  Â  Â  Â  Â  Â  <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
Â  Â  Â  Â  Â  Â  Â  Â  <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
Â  Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  Â  Â  Bild wird generiert...
Â  Â  Â  Â  Â  Â  </>
Â  Â  Â  Â  Â  ) : (
Â  Â  Â  Â  Â  Â  <>
Â  Â  Â  Â  Â  Â  Â  <Aperture className="w-5 h-5 mr-3" /> Bild generieren
Â  Â  Â  Â  Â  Â  </>
Â  Â  Â  Â  Â  )}
Â  Â  Â  </button>
Â  Â  Â  
Â  Â  Â  {error && <div className="p-3 bg-red-100 text-red-700 border border-red-300 rounded-lg mb-4">{error}</div>}

Â  Â  Â  <div className="mt-6">
Â  Â  Â  Â  <h3 className="text-xl font-semibold mb-3 text-gray-700">Ergebnis (Kontext: {usageContext})</h3>
Â  Â  Â  Â  <div className="bg-white p-4 border border-gray-300 rounded-lg shadow-inner flex justify-center items-center min-h-[300px]">
Â  Â  Â  Â  Â  {isLoading && !imageURL && (
Â  Â  Â  Â  Â  Â  <div className="text-gray-500">Warte auf das generierte Bild...</div>
Â  Â  Â  Â  Â  )}
Â  Â  Â  Â  Â  {imageURL && (
Â  Â  Â  Â  Â  Â  <img src={imageURL} alt="Generiertes Bild" className="max-w-full h-auto rounded-lg shadow-lg" />
Â  Â  Â  Â  Â  )}
Â  Â  Â  Â  Â  {!isLoading && !imageURL && !error && (
Â  Â  Â  Â  Â  Â  <div className="text-gray-500">Generiertes Bild erscheint hier.</div>
Â  Â  Â  Â  Â  )}
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  );
};

// --- Komponente: Bildbearbeitung (I2I) ---
const ImageEditor = ({ userId }) => {
Â  const [editPrompt, setEditPrompt] = useState('FÃ¼ge dem Hauptobjekt einen Cyberpunk-Helm hinzu.');
Â  const [file, setFile] = useState(null);
Â  const [editedImageURL, setEditedImageURL] = useState('');
Â  const [isLoading, setIsLoading] = useState(false);
Â  const [error, setError] = useState('');
Â  const [previewURL, setPreviewURL] = useState('');
Â  const [usageContext, setUsageContext] = useState('FÃ¼r Kundenprojekt');

Â  const contextOptions = ['FÃ¼r Kundenprojekt', 'Retusche/Korrektur', 'Stil-Transfer', 'Allgemeine Anfrage'];
Â  
Â  const getFullPrompt = (p) => {
Â  Â  return `Kontext: ${usageContext}. Bearbeite das Bild basierend auf dieser User-Anfrage: ${p}`;
Â  }

Â  const handleFileChange = (e) => {
Â  Â  const selectedFile = e.target.files[0];
Â  Â  if (selectedFile) {
Â  Â  Â  setFile(selectedFile);
Â  Â  Â  setPreviewURL(URL.createObjectURL(selectedFile));
Â  Â  Â  setEditedImageURL('');
Â  Â  Â  setError('');
Â  Â  }
Â  };
Â  
Â  // Konvertiert File-Objekt in Base64-String
Â  const fileToBase64 = (file) => {
Â  Â  return new Promise((resolve, reject) => {
Â  Â  Â  const reader = new FileReader();
Â  Â  Â  reader.onload = () => resolve(reader.result.split(',')[1]); // Nur der Base64-Teil
Â  Â  Â  reader.onerror = error => reject(error);
Â  Â  Â  reader.readAsDataURL(file);
Â  Â  });
Â  };

Â  // --- Gemini API Call (I2I - Bildbearbeitung) ---
Â  const editImage = async () => {
Â  Â  if (!file) {
Â  Â  Â  setError('âŒ Bitte zuerst ein Bild hochladen.');
Â  Â  Â  return;
Â  Â  }
Â  Â  setIsLoading(true);
Â  Â  setEditedImageURL('');
Â  Â  setError('');
Â  Â  const fullQuery = getFullPrompt(editPrompt);

Â  Â  try {
Â  Â  Â  const base64ImageData = await fileToBase64(file);
Â  Â  Â  const payload = {
Â  Â  Â  Â  Â  contents: [
Â  Â  Â  Â  Â  Â  Â  {
Â  Â  Â  Â  Â  Â  Â  Â  Â  role: "user",
Â  Â  Â  Â  Â  Â  Â  Â  Â  parts: [
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { text: fullQuery }, // Der Text-Prompt zur Bearbeitung
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  inlineData: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mimeType: file.type, 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data: base64ImageData // Das hochgeladene Bild
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  ]
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  ],
Â  Â  Â  Â  Â  generationConfig: {
Â  Â  Â  Â  Â  Â  Â  responseModalities: ['IMAGE'] // Signalisiert die I2I-Generierung
Â  Â  Â  Â  Â  },
Â  Â  Â  };
Â  Â  Â  Â  
Â  Â  Â  const apiKey = API_KEY_PLACEHOLDER;
Â  Â  Â  // Verwenden Sie gemini-2.5-flash-image-preview fÃ¼r Bildbearbeitung (I2I)
Â  Â  Â  const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;

Â  Â  Â  const response = await fetch(apiUrl, {
Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  body: JSON.stringify(payload)
Â  Â  Â  });

Â  Â  Â  const result = await response.json();
Â  Â  Â  const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

Â  Â  Â  if (base64Data) {
Â  Â  Â  Â  Â  const imageUrl = `data:${file.type};base64,${base64Data}`;
Â  Â  Â  Â  Â  setEditedImageURL(imageUrl);
Â  Â  Â  } else {
Â  Â  Â  Â  Â  setError('âŒ Fehler bei der Bildbearbeitung. UngÃ¼ltige Antwortstruktur von der Gemini API.');
Â  Â  Â  Â  Â  console.error("API Response Error:", result);
Â  Â  Â  }

Â  Â  } catch (err) {
Â  Â  Â  Â  setError(`âŒ Ein Fehler ist aufgetreten: ${err.message}`);
Â  Â  Â  Â  console.error("Fetch Error:", err);
Â  Â  } finally {
Â  Â  Â  Â  setIsLoading(false);
Â  Â  }
Â  };
Â  
Â  return (
Â  Â  <div className="p-6 bg-gray-50 min-h-screen rounded-b-xl">
Â  Â  Â  <h2 className="text-3xl font-extrabold text-red-700 mb-6 flex items-center">
Â  Â  Â  Â  <Edit className="w-8 h-8 mr-3" /> Bildbearbeitung (Bild-zu-Bild / I2I)
Â  Â  Â  </h2>

Â  Â  Â  {/* Verwendungszweck Dropdown */}
Â  Â  Â  <div className="mb-4">
Â  Â  Â  Â  <label className="block text-gray-700 text-sm font-bold mb-2">Verwendungszweck (STEURN)</label>
Â  Â  Â  Â  <select
Â  Â  Â  Â  Â  value={usageContext}
Â  Â  Â  Â  Â  onChange={(e) => setUsageContext(e.target.value)}
Â  Â  Â  Â  Â  className="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-red-500 focus:border-red-500 bg-white"
Â  Â  Â  Â  >
Â  Â  Â  Â  Â  {contextOptions.map(option => (
Â  Â  Â  Â  Â  Â  <option key={option} value={option}>{option}</option>
Â  Â  Â  Â  Â  ))}
Â  Â  Â  Â  </select>
Â  Â  Â  </div>

Â  Â  Â  <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
Â  Â  Â  Â  {/* Upload / Originalbild */}
Â  Â  Â  Â  <div className="flex flex-col">
Â  Â  Â  Â  Â  <label className="block text-gray-700 text-sm font-bold mb-2 flex items-center">
Â  Â  Â  Â  Â  Â  <Upload className="w-4 h-4 mr-1"/> 1. Originalbild hochladen
Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  <input
Â  Â  Â  Â  Â  Â  type="file"
Â  Â  Â  Â  Â  Â  accept="image/*"
Â  Â  Â  Â  Â  Â  onChange={handleFileChange}
Â  Â  Â  Â  Â  Â  className="w-full p-3 border border-gray-300 rounded-lg shadow-sm bg-white text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-red-50 file:text-red-700 hover:file:bg-red-100"
Â  Â  Â  Â  Â  />
Â  Â  Â  Â  Â  <div className="mt-4 bg-white p-4 border border-gray-300 rounded-lg shadow-inner flex justify-center items-center min-h-[150px]">
Â  Â  Â  Â  Â  Â  {previewURL ? (
Â  Â  Â  Â  Â  Â  Â  <img src={previewURL} alt="Vorschau Original" className="max-w-full max-h-[250px] h-auto rounded-lg shadow-md" />
Â  Â  Â  Â  Â  Â  ) : (
Â  Â  Â  Â  Â  Â  Â  <div className="text-gray-500 text-center">Bildvorschau (Original)</div>
Â  Â  Â  Â  Â  Â  )}
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  {/* Bearbeitungsprompt */}
Â  Â  Â  Â  <div className="flex flex-col">
Â  Â  Â  Â  Â  <label className="block text-gray-700 text-sm font-bold mb-2 flex items-center">
Â  Â  Â  Â  Â  Â  <Edit className="w-4 h-4 mr-1"/> 2. Bearbeitungs-Prompt
Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  <textarea
Â  Â  Â  Â  Â  Â  value={editPrompt}
Â  Â  Â  Â  Â  Â  onChange={(e) => setEditPrompt(e.target.value)}
Â  Â  Â  Â  Â  Â  placeholder="Beschreiben Sie, wie das Bild bearbeitet werden soll..."
Â  Â  Â  Â  Â  Â  rows="8"
Â  Â  Â  Â  Â  Â  className="w-full p-3 border border-gray-300 rounded-lg shadow-inner resize-none focus:ring-red-500 focus:border-red-500"
Â  Â  Â  Â  Â  />
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â  
Â  Â  Â  {error && <div className="p-3 bg-red-100 text-red-700 border border-red-300 rounded-lg mb-4">{error}</div>}

Â  Â  Â  <button
Â  Â  Â  Â  onClick={editImage}
Â  Â  Â  Â  disabled={isLoading || !file}
Â  Â  Â  Â  className="w-full bg-red-600 hover:bg-red-700 text-white font-extrabold py-3 px-4 rounded-lg transition duration-200 shadow-xl disabled:opacity-50 flex items-center justify-center text-lg mb-6"
Â  Â  Â  >
Â  Â  Â  Â  {isLoading ? (
Â  Â  Â  Â  Â  Â  <>
Â  Â  Â  Â  Â  Â  Â  <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
Â  Â  Â  Â  Â  Â  Â  Â  <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
Â  Â  Â  Â  Â  Â  Â  Â  <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
Â  Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  Â  Â  Bild wird bearbeitet...
Â  Â  Â  Â  Â  Â  </>
Â  Â  Â  Â  Â  ) : (
Â  Â  Â  Â  Â  Â  <>
Â  Â  Â  Â  Â  Â  Â  <Edit className="w-5 h-5 mr-3" /> Bild bearbeiten (I2I)
Â  Â  Â  Â  Â  Â  </>
Â  Â  Â  Â  Â  )}
Â  Â  Â  </button>
Â  Â  Â  
Â  Â  Â  <div className="mt-6">
Â  Â  Â  Â  <h3 className="text-xl font-semibold mb-3 text-gray-700">3. Ergebnis (Kontext: {usageContext})</h3>
Â  Â  Â  Â  <div className="bg-white p-4 border border-gray-300 rounded-lg shadow-inner flex justify-center items-center min-h-[300px]">
Â  Â  Â  Â  Â  {isLoading && !editedImageURL && (
Â  Â  Â  Â  Â  Â  <div className="text-gray-500">Warte auf das bearbeitete Bild...</div>
Â  Â  Â  Â  Â  )}
Â  Â  Â  Â  Â  {editedImageURL && (
Â  Â  Â  Â  Â  Â  <img src={editedImageURL} alt="Bearbeitetes Bild" className="max-w-full h-auto rounded-lg shadow-lg" />
Â  Â  Â  Â  Â  )}
Â  Â  Â  Â  Â  {!isLoading && !editedImageURL && !error && (
Â  Â  Â  Â  Â  Â  <div className="text-gray-500">Das bearbeitete Bild erscheint hier.</div>
Â  Â  Â  Â  Â  )}
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  );
};


// --- Hauptkomponente: App mit Tab-Navigation ---
const App = () => {
Â  const [db, setDb] = useState(null);
Â  const [auth, setAuth] = useState(null);
Â  const [userId, setUserId] = useState('Anonyme Sitzung');
Â  const [activeTab, setActiveTab] = useState('Keys');

Â  // 1. Firebase Initialisierung und Authentifizierung
Â  useEffect(() => {
Â  Â  if (dbInstance && authInstance) {
Â  Â  Â  setDb(dbInstance);
Â  Â  Â  setAuth(authInstance);

Â  Â  Â  const initializeAuth = async () => {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  if (initialAuthToken) {
Â  Â  Â  Â  Â  Â  await signInWithCustomToken(authInstance, initialAuthToken);
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  await signInAnonymously(authInstance);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  console.error("Firebase Auth Error:", error);
Â  Â  Â  Â  Â  // Fallback: Nutzung einer zufÃ¤lligen ID, falls Auth fehlschlÃ¤gt
Â  Â  Â  Â  Â  setUserId(`fallback-${crypto.randomUUID()}`);
Â  Â  Â  Â  }
Â  Â  Â  };

Â  Â  Â  initializeAuth();

Â  Â  Â  // Auth State Listener
Â  Â  Â  const unsubscribe = onAuthStateChanged(authInstance, (user) => {
Â  Â  Â  Â  if (user) {
Â  Â  Â  Â  Â  setUserId(user.uid);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  // Dies wird bei erfolgreicher anonymer Anmeldung nur ausgefÃ¼hrt, wenn der Token fehlt
Â  Â  Â  Â  Â  setUserId('Anonyme Sitzung');
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  Â  return () => unsubscribe();
Â  Â  }
Â  }, []); // Nur einmal ausfÃ¼hren

Â  const TabButton = ({ tabName, icon: Icon, colorClass }) => (
Â  Â  <button
Â  Â  Â  onClick={() => setActiveTab(tabName)}
Â  Â  Â  className={`
Â  Â  Â  Â  flex-1 flex flex-col items-center justify-center p-3 rounded-t-xl transition duration-300 ease-in-out font-bold text-sm md:text-base
Â  Â  Â  Â  ${activeTab === tabName
Â  Â  Â  Â  Â  ? `bg-white ${colorClass} border-t-4 border-b-0 shadow-lg`
Â  Â  Â  Â  Â  : `bg-gray-100 text-gray-600 hover:bg-gray-200 border-t-2 border-gray-300`
Â  Â  Â  Â  }
Â  Â  Â  `}
Â  Â  >
Â  Â  Â  <Icon className={`w-6 h-6 mb-1 ${activeTab !== tabName && 'text-gray-500'}`} />
Â  Â  Â  <span className="hidden md:inline">{tabName}</span>
Â  Â  </button>
Â  );

Â  const renderContent = () => {
Â  Â  if (!db || !userId || !auth) {
Â  Â  Â  return (
Â  Â  Â  Â  <div className="p-10 text-center bg-white rounded-lg shadow-xl mt-4">
Â  Â  Â  Â  Â  <AlertTriangle className="w-10 h-10 text-yellow-500 mx-auto mb-4"/>
Â  Â  Â  Â  Â  <h3 className="text-xl font-bold text-gray-700">Initialisiere Zenith Core Services...</h3>
Â  Â  Â  Â  Â  <p className="text-gray-500">Warte auf Firebase/Auth-Verbindung. (User ID: {userId})</p>
Â  Â  Â  Â  </div>
Â  Â  Â  );
Â  Â  }

Â  Â  switch (activeTab) {
Â  Â  Â  case 'Keys':
Â  Â  Â  Â  return <ZenithKeyController userId={userId} db={db} />;
Â  Â  Â  case 'KI Text/Vision':
Â  Â  Â  Â  return <AIMasterTool userId={userId} />;
Â  Â  Â  case 'Bildgenerator (T2I)':
Â  Â  Â  Â  return <ImageGenerator userId={userId} />;
Â  Â  Â  case 'Bildbearbeitung (I2I)':
Â  Â  Â  Â  return <ImageEditor userId={userId} />;
Â  Â  Â  default:
Â  Â  Â  Â  return <p className="p-6">WÃ¤hlen Sie einen Service.</p>;
Â  Â  }
Â  };

Â  return (
Â  Â  <div className="min-h-screen bg-gray-100 p-0 sm:p-4 font-sans antialiased">
Â  Â  Â  <div className="max-w-7xl mx-auto bg-gray-50 rounded-xl shadow-2xl overflow-hidden">
Â  Â  Â  Â  {/* Header und Tabs */}
Â  Â  Â  Â  <header className="bg-white p-4 shadow-lg sticky top-0 z-10">
Â  Â  Â  Â  Â  <div className="text-4xl font-extrabold text-gray-900 mb-4 flex items-center">
Â  Â  Â  Â  Â  Â  <Shield className="w-10 h-10 text-blue-800 mr-3" />
Â  Â  Â  Â  Â  Â  ZENITH SCSC: Master Control
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div className="flex justify-between space-x-1 border-b-4 border-gray-300">
Â  Â  Â  Â  Â  Â  <TabButton tabName="Keys" icon={Lock} colorClass="text-blue-700 border-blue-600" />
Â  Â  Â  Â  Â  Â  <TabButton tabName="KI Text/Vision" icon={MessageSquare} colorClass="text-green-700 border-green-600" />
Â  Â  Â  Â  Â  Â  <TabButton tabName="Bildgenerator (T2I)" icon={Aperture} colorClass="text-purple-700 border-purple-600" />
Â  Â  Â  Â  Â  Â  <TabButton tabName="Bildbearbeitung (I2I)" icon={Edit} colorClass="text-red-700 border-red-600" />
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </header>
Â  Â  Â  Â  
Â  Â  Â  Â  {/* Inhaltsbereich */}
Â  Â  Â  Â  <main className="pb-8">
Â  Â  Â  Â  Â  {renderContent()}
Â  Â  Â  Â  </main>
Â  Â  Â  </div>
Â  Â  </div>
Â  );
};

export default App;
